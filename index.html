<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Customer Intake Form</title>
    <style>
        body {
            background-color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        form {
            background-color: #333;
            padding: 20px;
            margin: 50px;
            max-width: 1000px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            color: white;
        }
        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .row input {
            flex: 1;
            min-width: 150px;
            max-width: 250px;
            padding: 5px;
            color: white;
            background-color: #444;
            border: 1px solid #666;
        }
        .row input::placeholder {
            color: #ccc;
            opacity: 1;
        }
        #customer_name {
            max-width: 400px;
            width: 100%;
            color: white;
            background-color: #444;
            border: 1px solid #666;
        }
        #customer_name::placeholder {
            color: #ccc;
            opacity: 1;
        }
        #notes {
            max-width: 500px;
            width: 100%;
            height: 100px;
            color: white;
            background-color: #444;
            border: 1px solid #666;
        }
        #notes::placeholder {
            color: #ccc;
            opacity: 1;
        }
        #dist_location {
            color: white;
            background-color: #444;
            border: 1px solid #666;
        }
        #dist_location::placeholder {
            color: #ccc;
            opacity: 1;
        }
        input[name^="delivery_hours"] {
            color: white;
            background-color: #444;
            border: 1px solid #666;
            width: 250px;
        }
        input[name^="delivery_hours"]::placeholder {
            color: #ccc;
            opacity: 1;
        }
        input[name="other_pricing"] {
            color: white;
            background-color: #444;
            border: 1px solid #666;
            max-width: 250px;
        }
        input[name="other_pricing"]::placeholder {
            color: #ccc;
            opacity: 1;
        }
        div {
            margin-bottom: 15px;
        }
        label, input, select, textarea {
            display: inline-block;
            text-align: center;
            color: white;
        }
        select {
            background-color: #444;
            border: 1px solid #666;
        }
        button {
            margin: 15px auto;
            padding: 10px 20px;
            background-color: #444;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            color: white;
        }
        button:hover {
            background-color: #555;
        }
        #locations {
            text-align: center;
        }
        .location {
            margin-bottom: 20px;
        }
        #gpo_options, #dist_options, #other_pricing {
            text-align: center;
        }
        #signature-pad {
            border: 1px solid #666;
            background-color: #222;
            width: 90%;
            max-width: 400px;
            height: 150px;
            display: block;
            touch-action: none;
        }
        #open-signature-modal {
            display: none;
        }
        #signature-section {
            margin-top: 20px;
        }
        .signature-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .radio-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        .radio-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
            align-items: center;
        }
        .radio-buttons input {
            margin-right: 5px;
        }
        .dropdown-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .dropdown-field {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        .w9-message {
            font-weight: bold;
            color: #00FFFF;
            margin-top: 5px;
            font-size: 16px;
            font-style: italic;
        }
        .tax-exempt-message, .payment-terms-message {
            color: #00FFFF;
        }
        .logo-container {
            margin-bottom: 10px;
            text-align: center;
            padding: 10px;
        }
        .logo-container img {
            width: 150px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        #multi_location_message {
            color: green;
        }
        .accounts-payable {
            display: block;
        }
        .accounts-payable.hidden {
            display: none;
        }
        .signature-feedback, .form-error {
            color: #ff5555;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
        .form-success {
            color: #00ff00;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
        /* Modal Styles */
        #signature-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #222;
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
        #modal-canvas {
            border: 1px solid #666;
            background-color: #222;
            width: 100%;
            height: calc(100% - 120px);
            touch-action: none;
        }
        #modal-instructions {
            color: #ccc;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }
        #modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #modal-orientation-prompt {
            color: #ff5555;
            font-size: 16px;
            margin-bottom: 10px;
            display: none;
            text-align: center;
        }
        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            form {
                margin: 20px;
                padding: 15px;
            }
            .row input {
                min-width: 100px;
                max-width: 200px;
            }
            #signature-pad {
                display: none;
            }
            #open-signature-modal {
                display: block;
            }
            #customer_name {
                max-width: 300px;
            }
            #notes {
                max-width: 300px;
            }
            input[name^="delivery_hours"] {
                width: 200px;
            }
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
        }
        /* Enforce Landscape for Modal */
        @media (max-width: 600px) and (orientation: portrait) {
            #signature-modal {
                display: flex;
            }
            #modal-canvas {
                display: none;
            }
            #modal-orientation-prompt {
                display: block;
            }
        }
        @media (max-width: 600px) and (orientation: landscape) {
            #modal-canvas {
                display: block;
            }
            #modal-orientation-prompt {
                display: none;
            }
        }
    </style>
    <script>
        function updateAccountsPayableVisibility() {
            const multiLocationYes = document.getElementById('multi_location_yes')?.checked || false;
            const rgSetupYes = document.getElementById('rg_setup_yes')?.checked || false;
            const billingCentralized = document.getElementById('billing_centralized')?.checked || false;
            const apSections = document.querySelectorAll('.accounts-payable');
           
            if (multiLocationYes && rgSetupYes && billingCentralized) {
                apSections.forEach(section => section.classList.add('hidden'));
            } else {
                apSections.forEach(section => section.classList.remove('hidden'));
            }
        }
        function addLocation() {
            var locations = document.getElementById('locations');
            var count = locations.getElementsByClassName('location').length;
            var singleBillingYes = document.getElementById('single_billing_yes')?.checked || false;
            var newLoc;
            if (singleBillingYes) {
                newLoc = document.createElement('div');
                newLoc.className = 'location';
                newLoc.innerHTML = `
                    <h2>Location ${count + 1} Information</h2>
                    <div>
                        <label>Purchasing Contact:</label>
                        <div class="row">
                            <input type="text" name="purchasing_first[${count}]" placeholder="First Name" required aria-label="Purchasing Contact First Name">
                            <input type="text" name="purchasing_last[${count}]" placeholder="Last Name" required aria-label="Purchasing Contact Last Name">
                        </div>
                        <div class="row">
                            <input type="email" name="purchasing_email[${count}]" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$" required aria-label="Purchasing Contact Email">
                            <input type="tel" name="purchasing_phone[${count}]" placeholder="Phone Number" pattern="[0-9]{10,}" required aria-label="Purchasing Contact Phone">
                        </div>
                    </div>
                    <div>
                        <label>Ship to Address:</label>
                        <div class="row">
                            <input type="text" name="ship_street[${count}]" placeholder="Street" required aria-label="Shipping Street">
                            <input type="text" name="ship_city[${count}]" placeholder="City" required aria-label="Shipping City">
                            <input type="text" name="ship_state[${count}]" placeholder="State" required aria-label="Shipping State">
                            <input type="text" name="ship_zip[${count}]" placeholder="Zip Code" pattern="[0-9]{5}(-[0-9]{4})?" required aria-label="Shipping Zip Code">
                        </div>
                    </div>
                    <div>
                        <label>Warehouse and/or Receiving Contact:</label>
                        <div class="row">
                            <input type="text" name="warehouse_first[${count}]" placeholder="First Name" required aria-label="Warehouse Contact First Name">
                            <input type="text" name="warehouse_last[${count}]" placeholder="Last Name" required aria-label="Warehouse Contact Last Name">
                        </div>
                        <div class="row">
                            <input type="email" name="warehouse_email[${count}]" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$" required aria-label="Warehouse Contact Email">
                            <input type="tel" name="warehouse_phone[${count}]" placeholder="Phone Number" pattern="[0-9]{10,}" required aria-label="Warehouse Contact Phone">
                        </div>
                    </div>
                    <div class="dropdown-group">
                        <label for="delivery_hours[${count}]">Dock Availability:</label>
                        <div class="dropdown-field">
                            <input type="text" id="delivery_hours[${count}]" name="delivery_hours[${count}]" placeholder="Hours & Days" required aria-label="Dock Availability">
                        </div>
                    </div>
                    <div class="radio-group">
                        <label>Liftgate Required?</label>
                        <div class="radio-buttons">
                            <input type="radio" id="liftgate_yes[${count}]" name="liftgate[${count}]" value="yes" required>
                            <label for="liftgate_yes[${count}]">Yes</label>
                            <input type="radio" id="liftgate_no[${count}]" name="liftgate[${count}]" value="no">
                            <label for="liftgate_no[${count}]">No</label>
                        </div>
                    </div>
                    <div class="radio-group">
                        <label>Delivery Appointment Required?</label>
                        <div class="radio-buttons">
                            <input type="radio" id="appt_yes[${count}]" name="appt[${count}]" value="yes" required>
                            <label for="appt_yes[${count}]">Yes</label>
                            <input type="radio" id="appt_no[${count}]" name="appt[${count}]" value="no">
                            <label for="appt_no[${count}]">No</label>
                        </div>
                    </div>
                `;
            } else {
                newLoc = locations.getElementsByClassName('location')[0].cloneNode(true);
                newLoc.querySelector('h2').textContent = 'Location ' + (count + 1) + ' Information';
                var inputs = newLoc.querySelectorAll('input');
                for (var i = 0; i < inputs.length; i++) {
                    if (inputs[i].name) {
                        inputs[i].name = inputs[i].name.replace(/\[\d+\]/, '[' + count + ']');
                        inputs[i].value = '';
                        if (inputs[i].type === 'radio') {
                            inputs[i].checked = false;
                        }
                        if (inputs[i].name.startsWith('delivery_hours')) {
                            inputs[i].id = 'delivery_hours[' + count + ']';
                            inputs[i].setAttribute('aria-label', 'Dock Availability');
                            inputs[i].placeholder = 'Hours & Days';
                            inputs[i].setAttribute('required', 'required');
                        }
                        if (inputs[i].name.match(/^(purchasing|warehouse|ap)_(first|last|email|phone)\[\d+\]$/)) {
                            inputs[i].setAttribute('required', 'required');
                        }
                        if (inputs[i].name.startsWith('liftgate') || inputs[i].name.startsWith('appt')) {
                            inputs[i].setAttribute('required', 'required');
                        }
                    }
                }
                var label = newLoc.querySelector('label[for^="delivery_hours"]');
                if (label) {
                    label.textContent = 'Dock Availability:';
                    label.setAttribute('for', 'delivery_hours[' + count + ']');
                }
            }
            var removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = 'Remove Location';
            removeBtn.onclick = function() { removeLocation(this); };
            newLoc.appendChild(removeBtn);
           
            locations.appendChild(newLoc);
            updateAccountsPayableVisibility();
        }
        function removeLocation(button) {
            var locations = document.getElementById('locations');
            if (locations.getElementsByClassName('location').length > 1) {
                button.parentElement.remove();
                updateLocationHeaders();
                updateAccountsPayableVisibility();
            }
        }
        function updateLocationHeaders() {
            var locations = document.getElementById('locations').getElementsByClassName('location');
            for (var i = 0; i < locations.length; i++) {
                locations[i].querySelector('h2').textContent = (i === 0 ? 'Primary' : (i + 1)) + ' Information';
                var inputs = locations[i].querySelectorAll('input');
                for (var j = 0; j < inputs.length; j++) {
                    if (inputs[j].name) {
                        inputs[j].name = inputs[j].name.replace(/\[\d+\]/, '[' + i + ']');
                    }
                    if (inputs[j].name.startsWith('delivery_hours')) {
                        inputs[j].id = 'delivery_hours[' + i + ']';
                        inputs[j].setAttribute('aria-label', 'Dock Availability');
                        inputs[j].placeholder = 'Hours & Days';
                        inputs[j].setAttribute('required', 'required');
                    }
                    if (inputs[j].name.match(/^(purchasing|warehouse|ap)_(first|last|email|phone)\[\d+\]$/)) {
                        inputs[j].setAttribute('required', 'required');
                    }
                    if (inputs[j].name.startsWith('liftgate') || inputs[j].name.startsWith('appt')) {
                        inputs[i].setAttribute('required', 'required');
                    }
                }
                var label = locations[i].querySelector('label[for^="delivery_hours"]');
                if (label) {
                    label.setAttribute('for', 'delivery_hours[' + i + ']');
                    label.textContent = 'Dock Availability:';
                }
            }
            updateAccountsPayableVisibility();
        }
        function showGpoOptions() {
            document.getElementById('gpo_options').style.display = 'block';
        }
        function hideGpoOptions() {
            document.getElementById('gpo_options').style.display = 'none';
        }
        function showDistOptions() {
            document.getElementById('dist_options').style.display = 'block';
        }
        function hideDistOptions() {
            document.getElementById('dist_options').style.display = 'none';
        }
        function checkOther(select) {
            if (select.value === 'other') {
                document.getElementById('other_pricing').style.display = 'block';
            } else {
                document.getElementById('other_pricing').style.display = 'none';
            }
        }
        function showNetworkSetup() {
            document.getElementById('network_setup').style.display = 'block';
            document.getElementById('multi_location_message').style.display = 'block';
            updateSingleBillingVisibility();
            updateW9Display();
        }
        function hideNetworkSetup() {
            document.getElementById('network_setup').style.display = 'none';
            document.getElementById('multi_location_message').style.display = 'none';
            hideBillingType();
            updateSingleBillingVisibility();
            updateW9Display();
        }
        function showBillingType() {
            document.getElementById('billing_type').style.display = 'block';
            updateSingleBillingVisibility();
            updateW9Display();
        }
        function hideBillingType() {
            document.getElementById('billing_type').style.display = 'none';
            hideBillingMessages();
            updateSingleBillingVisibility();
            updateW9Display();
        }
        function showLocalizedMessage() {
            document.getElementById('localized_message').style.display = 'block';
            document.getElementById('centralized_message').style.display = 'none';
            updateW9Display();
        }
        function showCentralizedMessage() {
            document.getElementById('centralized_message').style.display = 'block';
            document.getElementById('localized_message').style.display = 'none';
            updateW9Display();
        }
        function hideBillingMessages() {
            document.getElementById('localized_message').style.display = 'none';
            document.getElementById('centralized_message').style.display = 'none';
            updateW9Display();
        }
        function updateSingleBillingVisibility() {
            const multiLocationYes = document.getElementById('multi_location_yes').checked;
            const rgSetupNo = document.getElementById('rg_setup_no')?.checked || false;
            const singleBillingDiv = document.getElementById('single_billing');
            if (singleBillingDiv) {
                singleBillingDiv.style.display = multiLocationYes && rgSetupNo ? 'flex' : 'none';
            }
            const singleBillingMessage = document.getElementById('single_billing_message');
            if (singleBillingMessage) singleBillingMessage.style.display = 'none';
            updateAccountsPayableVisibility();
        }
        function showSingleBillingMessage() {
            const singleBillingMessage = document.getElementById('single_billing_message');
            if (singleBillingMessage) {
                singleBillingMessage.style.display = document.getElementById('single_billing_no').checked ? 'block' : 'none';
            }
            updateAccountsPayableVisibility();
        }
        function updateW9Display() {
            const w9Message = document.querySelector('.w9-message');
            if (!w9Message) return;
            const multiLocationYes = document.getElementById('multi_location_yes').checked;
            const multiLocationNo = document.getElementById('multi_location_no').checked;
            const rgSetupYes = document.getElementById('rg_setup_yes')?.checked || false;
            const rgSetupNo = document.getElementById('rg_setup_no')?.checked || false;
            const billingLocalized = document.getElementById('billing_localized')?.checked || false;
            if ((multiLocationYes && rgSetupNo) || multiLocationNo || (multiLocationYes && rgSetupYes && billingLocalized)) {
                w9Message.style.display = 'block';
            } else {
                w9Message.style.display = 'none';
            }
        }

        // Validate form fields
        function validateForm() {
            const form = document.querySelector('form');
            const inputs = form.querySelectorAll('input[required], select[required]');
            let isValid = true;

            // Clear previous error messages
            document.querySelectorAll('.form-error').forEach(el => el.remove());

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                    input.setAttribute('aria-invalid', 'true');
                    const errorMsg = document.createElement('span');
                    errorMsg.className = 'form-error';
                    errorMsg.textContent = `${input.getAttribute('aria-label')} is required.`;
                    input.parentNode.appendChild(errorMsg);
                } else {
                    input.classList.remove('error');
                    input.setAttribute('aria-invalid', 'false');
                }
            });

            // Validate signature
            const signatureData = document.getElementById('signature-data').value;
            if (!signatureData) {
                isValid = false;
                const signatureError = document.createElement('span');
                signatureError.className = 'form-error signature-feedback';
                signatureError.textContent = 'Please provide a signature.';
                signatureError.setAttribute('role', 'alert');
                const signatureSection = document.getElementById('signature-section');
                if (!signatureSection.querySelector('.signature-feedback')) {
                    signatureSection.appendChild(signatureError);
                    setTimeout(() => signatureError.remove(), 3000);
                }
            }

            return isValid;
        }

        window.onload = function() {
            const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const signatureSection = document.getElementById('signature-section');
            const signaturePad = document.getElementById('signature-pad');
            const signatureButton = document.getElementById('open-signature-modal');
            const signatureModal = document.getElementById('signature-modal');
            const modalCanvas = document.getElementById('modal-canvas');
            const modalOrientationPrompt = document.getElementById('modal-orientation-prompt');
            const ctx = signaturePad.getContext('2d');
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            let modalCtx = modalCanvas ? modalCanvas.getContext('2d') : null;
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // Show/hide signature pad vs modal button
            if (isMobile) {
                signaturePad.style.display = 'none';
                signatureButton.style.display = 'block';
            } else {
                signaturePad.style.display = 'block';
                signatureButton.style.display = 'none';
            }

            // Debounce function for resize
            function debounce(fn, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn(...args), wait);
                };
            }

            // Resize desktop canvas
            function resizeCanvas() {
                const rect = signaturePad.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                signaturePad.width = rect.width * dpr;
                signaturePad.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                ctx.strokeStyle = '#ffffff';
                signaturePad.style.width = rect.width + 'px';
                signaturePad.style.height = rect.height + 'px';
            }

            // Resize modal canvas
            function resizeModalCanvas() {
                if (!modalCanvas) return;
                const rect = modalCanvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                modalCanvas.width = rect.width * dpr;
                modalCanvas.height = rect.height * dpr;
                modalCtx.scale(dpr, dpr);
                modalCtx.strokeStyle = '#ffffff';
                modalCanvas.style.width = rect.width + 'px';
                modalCanvas.style.height = rect.height + 'px';
            }

            // Check orientation
            function checkOrientation() {
                if (!isMobile || !modalOrientationPrompt) return;
                const isLandscape = window.matchMedia("(orientation: landscape)").matches;
                modalOrientationPrompt.style.display = isLandscape ? 'none' : 'block';
                modalCanvas.style.display = isLandscape ? 'block' : 'none';
            }

            // Desktop signature pad events
            if (!isMobile) {
                window.addEventListener('resize', debounce(resizeCanvas, 100));
                resizeCanvas();

                signaturePad.setAttribute('tabindex', '0');
                signaturePad.setAttribute('aria-label', 'Draw your signature here');
                signaturePad.setAttribute('role', 'application');
                signaturePad.setAttribute('aria-describedby', 'signature-instructions');
                signaturePad.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        const feedback = document.createElement('span');
                        feedback.className = 'signature-feedback';
                        feedback.textContent = 'Please use a mouse to draw your signature.';
                        feedback.style.color = '#ff5555';
                        feedback.setAttribute('role', 'alert');
                        if (!signatureSection.querySelector('.signature-feedback')) {
                            signatureSection.appendChild(feedback);
                            setTimeout(() => feedback.remove(), 3000);
                        }
                    }
                });

                signaturePad.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    const rect = signaturePad.getBoundingClientRect();
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                });
                signaturePad.addEventListener('mousemove', (e) => {
                    if (isDrawing) {
                        const rect = signaturePad.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        lastX = x;
                        lastY = y;
                    }
                });
                signaturePad.addEventListener('mouseup', () => isDrawing = false);
                signaturePad.addEventListener('mouseout', () => isDrawing = false);
            }

            // Mobile signature modal events
            if (isMobile && modalCanvas) {
                modalCtx.strokeStyle = '#ffffff';
                modalCtx.lineWidth = 2;

                window.addEventListener('resize', debounce(resizeModalCanvas, 100));
                window.addEventListener('orientationchange', checkOrientation);
                resizeModalCanvas();
                checkOrientation();

                modalCanvas.setAttribute('tabindex', '0');
                modalCanvas.setAttribute('aria-label', 'Draw your signature here');
                modalCanvas.setAttribute('role', 'application');
                modalCanvas.setAttribute('aria-describedby', 'modal-instructions');
                modalCanvas.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        const feedback = document.createElement('span');
                        feedback.className = 'signature-feedback';
                        feedback.textContent = 'Please use touch to draw your signature.';
                        feedback.style.color = '#ff5555';
                        feedback.setAttribute('role', 'alert');
                        if (!signatureModal.querySelector('.signature-feedback')) {
                            signatureModal.appendChild(feedback);
                            setTimeout(() => feedback.remove(), 3000);
                        }
                    }
                });

                modalCanvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = modalCanvas.getBoundingClientRect();
                    isDrawing = true;
                    lastX = (touch.clientX - rect.left - window.scrollX) * (modalCanvas.width / rect.width);
                    lastY = (touch.clientY - rect.top - window.scrollY) * (modalCanvas.height / rect.height);
                });
                modalCanvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (isDrawing) {
                        const touch = e.touches[0];
                        const rect = modalCanvas.getBoundingClientRect();
                        const x = (touch.clientX - rect.left - window.scrollX) * (modalCanvas.width / rect.width);
                        const y = (touch.clientY - rect.top - window.scrollY) * (modalCanvas.height / rect.height);
                        modalCtx.beginPath();
                        modalCtx.moveTo(lastX, lastY);
                        modalCtx.lineTo(x, y);
                        modalCtx.stroke();
                        lastX = x;
                        lastY = y;
                    }
                });
                modalCanvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    isDrawing = false;
                });
                modalCanvas.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    isDrawing = false;
                });

                // Modal open/close
                signatureButton.addEventListener('click', () => {
                    signatureModal.style.display = 'flex';
                    checkOrientation();
                    resizeModalCanvas();
                    modalCanvas.focus();
                });

                document.getElementById('save-signature').addEventListener('click', () => {
                    const signatureData = modalCanvas.toDataURL('image/png');
                    document.getElementById('signature-data').value = signatureData;
                    const img = new Image();
                    img.src = signatureData;
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, signaturePad.width, signaturePad.height);
                    };
                    signatureModal.style.display = 'none';
                    const feedback = document.createElement('span');
                    feedback.className = 'form-success signature-feedback';
                    feedback.textContent = 'Signature saved.';
                    feedback.setAttribute('role', 'status');
                    if (!signatureSection.querySelector('.signature-feedback')) {
                        signatureSection.appendChild(feedback);
                        setTimeout(() => feedback.remove(), 2000);
                    }
                });

                document.getElementById('close-signature-modal').addEventListener('click', () => {
                    signatureModal.style.display = 'none';
                });

                // Close modal with Esc key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && signatureModal.style.display === 'flex') {
                        signatureModal.style.display = 'none';
                    }
                });
            }

            document.getElementById('clear-signature').addEventListener('click', () => {
                ctx.clearRect(0, 0, signaturePad.width, signaturePad.height);
                if (modalCtx) modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
                document.getElementById('signature-data').value = '';
                ctx.strokeStyle = '#ffffff';
                if (modalCtx) modalCtx.strokeStyle = '#ffffff';
                const feedback = document.createElement('span');
                feedback.className = 'form-success signature-feedback';
                feedback.textContent = 'Signature cleared.';
                feedback.setAttribute('role', 'status');
                if (!signatureSection.querySelector('.signature-feedback')) {
                    signatureSection.appendChild(feedback);
                    setTimeout(() => feedback.remove(), 2000);
                }
            });

            // Form submission
            document.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm()) {
                    return;
                }

                const form = document.querySelector('form');
                const formData = new FormData(form);

                try {
                    const response = await fetch(form.getAttribute('action') || '/.netlify/functions/submit-form', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const successMsg = document.createElement('span');
                        successMsg.className = 'form-success';
                        successMsg.textContent = 'Form submitted successfully!';
                        successMsg.setAttribute('role', 'status');
                        form.appendChild(successMsg);
                        setTimeout(() => successMsg.remove(), 3000);
                        form.reset();
                        ctx.clearRect(0, 0, signaturePad.width, signaturePad.height);
                        if (modalCtx) modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
                        document.getElementById('signature-data').value = '';
                    } else {
                        throw new Error('Submission failed');
                    }
                } catch (error) {
                    const errorMsg = document.createElement('span');
                    errorMsg.className = 'form-error';
                    errorMsg.textContent = 'Error submitting form. Please try again.';
                    errorMsg.setAttribute('role', 'alert');
                    form.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 3000);
                }
            });

            document.getElementById('tax_exempt_yes').addEventListener('change', () => {
                document.getElementById('tax_exempt_message').style.display = 'block';
                updateW9Display();
            });
            document.getElementById('tax_exempt_no').addEventListener('change', () => {
                document.getElementById('tax_exempt_message').style.display = 'none';
                updateW9Display();
            });
            document.getElementById('payment_terms_yes').addEventListener('change', () => {
                document.getElementById('payment_terms_message').style.display = 'block';
                document.getElementById('payment_terms_no_message').style.display = 'none';
                updateW9Display();
            });
            document.getElementById('payment_terms_no').addEventListener('change', () => {
                document.getElementById('payment_terms_message').style.display = 'none';
                document.getElementById('payment_terms_no_message').style.display = 'block';
                updateW9Display();
            });
            document.getElementById('multi_location_yes').addEventListener('change', () => { showNetworkSetup(); updateW9Display(); });
            document.getElementById('multi_location_no').addEventListener('change', () => { hideNetworkSetup(); updateW9Display(); });
            document.getElementById('rg_setup_yes').addEventListener('change', () => {
                showBillingType();
                updateW9Display();
            });
            document.getElementById('rg_setup_no').addEventListener('change', () => {
                hideBillingType();
                updateW9Display();
            });
            document.getElementById('billing_centralized').addEventListener('change', () => {
                showCentralizedMessage();
                updateW9Display();
            });
            document.getElementById('billing_localized').addEventListener('change', () => {
                showLocalizedMessage();
                updateW9Display();
            });
            document.getElementById('single_billing_yes').addEventListener('change', () => { showSingleBillingMessage(); updateW9Display(); });
            document.getElementById('single_billing_no').addEventListener('change', () => { showSingleBillingMessage(); updateW9Display(); });
            document.getElementById('save-form').addEventListener('click', saveForm);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            loadForm();
            updateAccountsPayableVisibility();
            updateW9Display();
        };
        function saveForm() {
            const form = document.querySelector('form');
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (!data[key]) {
                    data[key] = value;
                } else {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                }
            }
            const locations = document.getElementById('locations').getElementsByClassName('location').length;
            data['num_locations'] = locations;
            data['signature'] = document.getElementById('signature-data').value;
            localStorage.setItem('customerIntakeForm', JSON.stringify(data));
            const feedback = document.createElement('span');
            feedback.className = 'form-success';
            feedback.textContent = 'Form saved!';
            feedback.setAttribute('role', 'status');
            form.appendChild(feedback);
            setTimeout(() => feedback.remove(), 2000);
        }
        function loadForm() {
            const saved = localStorage.getItem('customerIntakeForm');
            if (!saved) return;
            const data = JSON.parse(saved);
            const numLocations = data['num_locations'] || 1;
            const singleBillingYes = data['single_billing'] === 'yes';
            for (let i = 1; i < numLocations; i++) {
                addLocation();
            }
            for (let key in data) {
                if (key === 'num_locations' || key === 'signature') continue;
                const elements = document.querySelectorAll(`[name="${key}"]`);
                let values = Array.isArray(data[key]) ? data[key] : [data[key]];
                elements.forEach((el, idx) => {
                    if (el.type === 'radio' || el.type === 'checkbox') {
                        if (el.value === values[0]) el.checked = true;
                    } else {
                        el.value = values[idx] || '';
                    }
                });
            }
            if (document.getElementById('multi_location_yes').checked) showNetworkSetup();
            if (document.getElementById('rg_setup_yes').checked) showBillingType();
            if (document.getElementById('billing_centralized').checked) showCentralizedMessage();
            if (document.getElementById('billing_localized').checked) showLocalizedMessage();
            if (document.getElementById('gpo_yes').checked) showGpoOptions();
            if (document.getElementById('distributor_yes').checked) showDistOptions();
            if (document.getElementById('pricing').value === 'other') checkOther(document.getElementById('pricing'));
            if (document.getElementById('tax_exempt_yes').checked) document.getElementById('tax_exempt_message').style.display = 'block';
            if (document.getElementById('payment_terms_yes').checked) {
                document.getElementById('payment_terms_message').style.display = 'block';
                document.getElementById('payment_terms_no_message').style.display = 'none';
            } else if (document.getElementById('payment_terms_no').checked) {
                document.getElementById('payment_terms_message').style.display = 'none';
                document.getElementById('payment_terms_no_message').style.display = 'block';
            }
            updateSingleBillingVisibility();
            showSingleBillingMessage();
            if (data['signature']) {
                const ctx = document.getElementById('signature-pad').getContext('2d');
                const img = new Image();
                img.src = data['signature'];
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, ctx.canvas.width, ctx.canvas.height);
                };
            }
            updateAccountsPayableVisibility();
            updateW9Display();
        }
        function clearForm() {
            localStorage.removeItem('customerIntakeForm');
            document.querySelector('form').reset();
            const locations = document.getElementById('locations');
            while (locations.getElementsByClassName('location').length > 1) {
                locations.lastChild.remove();
            }
            hideGpoOptions();
            hideDistOptions();
            document.getElementById('other_pricing').style.display = 'none';
            document.getElementById('tax_exempt_message').style.display = 'none';
            document.getElementById('payment_terms_message').style.display = 'none';
            document.getElementById('payment_terms_no_message').style.display = 'none';
            hideNetworkSetup();
            document.getElementById('single_billing').style.display = 'none';
            document.getElementById('single_billing_message').style.display = 'none';
            document.getElementById('multi_location_message').style.display = 'none';
            const ctx = document.getElementById('signature-pad').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            const modalCanvas = document.getElementById('modal-canvas');
            if (modalCanvas) {
                const modalCtx = modalCanvas.getContext('2d');
                modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
            }
            document.getElementById('signature-data').value = '';
            const feedback = document.createElement('span');
            feedback.className = 'form-success';
            feedback.textContent = 'Form cleared!';
            feedback.setAttribute('role', 'status');
            document.querySelector('form').appendChild(feedback);
            setTimeout(() => feedback.remove(), 2000);
            updateAccountsPayableVisibility();
            updateW9Display();
        }
    </script>
</head>
<body>
    <form name="customer-intake" method="POST" data-netlify="true" netlify-honeypot="bot-field" action="/.netlify/functions/submit-form">
        <input type="hidden" name="form-name" value="customer-intake">
        <p hidden><label>Don't fill this out: <input name="bot-field"></label></p>
        <div class="logo-container">
            <img src="your-logo-file.png" alt="Company Logo">
        </div>
        <h1>New Customer Intake Form</h1>
        <div>
            <label for="customer_name">Customer Name:</label><br>
            <input type="text" id="customer_name" name="customer_name" required aria-label="Customer Name">
            <br><br>
            <h6 class="w9-message">Please provide an up to date W-9</h6>
        </div>
        <div class="radio-group">
            <label>Are you a part of a multi-location entity?</label>
            <div class="radio-buttons">
                <input type="radio" id="multi_location_yes" name="multi_location" value="yes" onclick="showNetworkSetup()">
                <label for="multi_location_yes">Yes</label>
                <input type="radio" id="multi_location_no" name="multi_location" value="no" onclick="hideNetworkSetup()">
                <label for="multi_location_no">No</label>
            </div>
        </div>
        <div id="multi_location_message" style="display:none; color:green;">
            Please add additional locations below to provide each location's shipping information
        </div>
        <div id="network_setup" style="display:none;">
            <div class="radio-group">
                <label>Is your network already set up with RG?</label>
                <div class="radio-buttons">
                    <input type="radio" id="rg_setup_yes" name="rg_setup" value="yes" onclick="showBillingType()">
                    <label for="rg_setup_yes">Yes</label>
                    <input type="radio" id="rg_setup_no" name="rg_setup" value="no" onclick="hideBillingType()">
                    <label for="rg_setup_no">No</label>
                </div>
            </div>
        </div>
        <div id="billing_type" style="display:none;">
            <div class="radio-group">
                <label>Is your billing centralized or localized?</label>
                <div class="radio-buttons">
                    <input type="radio" id="billing_centralized" name="billing" value="centralized" onclick="showCentralizedMessage()">
                    <label for="billing_centralized">Centralized</label>
                    <input type="radio" id="billing_localized" name="billing" value="localized" onclick="showLocalizedMessage()">
                    <label for="billing_localized">Localized</label>
                </div>
            </div>
            <div id="centralized_message" style="display:none; color:green;">
                By selecting this field RG will set up your location as a sub-account and send invoices to your parent company
            </div>
            <div id="localized_message" style="display:none; color:red;">
                In the primary information below please provide information relevant to your specific location
            </div>
        </div>
        <div class="radio-group">
            <label>Are you tax exempt?</label>
            <div class="radio-buttons">
                <input type="radio" id="tax_exempt_yes" name="tax_exempt" value="yes" required>
                <label for="tax_exempt_yes">Yes</label>
                <input type="radio" id="tax_exempt_no" name="tax_exempt" value="no">
                <label for="tax_exempt_no">No</label>
            </div>
        </div>
        <div id="tax_exempt_message" class="tax-exempt-message" style="display:none;">
            Please provide a tax-exemption form to your rep
        </div>
        <div class="radio-group">
            <label>Payment Terms Requested:</label>
            <div class="radio-buttons">
                <input type="radio" id="payment_terms_yes" name="payment_terms" value="yes" required>
                <label for="payment_terms_yes">Yes</label>
                <input type="radio" id="payment_terms_no" name="payment_terms" value="no">
                <label for="payment_terms_no">No</label>
            </div>
        </div>
        <div id="payment_terms_message" class="payment-terms-message" style="display:none;">
            Please provide a credit reference form to your rep
        </div>
        <div id="payment_terms_no_message" style="display:none; color:red;">
            By default customers are set up with Due On Receipt and can pay with check, card, or ACH link prior to or upon delivery
        </div>
        <div class="dropdown-group">
            <label for="rep">Who is the rep?</label>
            <div class="dropdown-field">
                <select id="rep" name="rep" required aria-label="Sales Representative">
                    <option value="">Select a rep</option>
                    <option>Kris</option>
                    <option>Tia</option>
                    <option>Leann</option>
                    <option>Kelly</option>
                    <option>Kelli</option>
                </select>
            </div>
        </div>
        <div class="radio-group">
            <label>Are you a member of a GPO?</label>
            <div class="radio-buttons">
                <input type="radio" id="gpo_yes" name="gpo" value="yes" required onclick="showGpoOptions()">
                <label for="gpo_yes">Yes</label>
                <input type="radio" id="gpo_no" name="gpo" value="no" onclick="hideGpoOptions()">
                <label for="gpo_no">No</label>
            </div>
        </div>
        <div id="gpo_options" style="display:none;">
            <select name="gpo_type" aria-label="GPO Type">
                <option>Premier</option>
                <option>Vizient</option>
                <option>VA</option>
                <option>Forum</option>
                <option>Sodexo</option>
            </select>
        </div>
        <div class="radio-group">
            <label>Will you purchase from a distributor?</label>
            <div class="radio-buttons">
                <input type="radio" id="distributor_yes" name="distributor" value="yes" required onclick="showDistOptions()">
                <label for="distributor_yes">Yes</label>
                <input type="radio" id="distributor_no" name="distributor" value="no" onclick="hideDistOptions()">
                <label for="distributor_no">No</label>
            </div>
        </div>
        <div id="dist_options" style="display:none;">
            <select name="dist_type" aria-label="Distributor Type">
                <option>US Foods</option>
                <option>Sysco</option>
                <option>GFS</option>
                <option>Food Buy</option>
                <option>Performance Food Group</option>
            </select>
            <input type="text" id="dist_location" name="dist_location" maxlength="50" placeholder="Distributor Location Name or Number" aria-label="Distributor Location">
        </div>
        <div class="dropdown-group">
            <label for="pricing">What pricing structure is this customer?</label>
            <div class="dropdown-field">
                <select id="pricing" name="pricing" onchange="checkOther(this)" aria-label="Pricing Structure">
                    <option>Frontline</option>
                    <option>GPO</option>
                    <option>WS</option>
                    <option>Coffee Shop</option>
                    <option>Sussex</option>
                    <option>Sodexo</option>
                    <option>other</option>
                </select>
            </div>
        </div>
        <div id="other_pricing" style="display:none;">
            <input type="text" name="other_pricing" maxlength="20" aria-label="Custom Pricing Structure">
        </div>
        <div id="single_billing" class="radio-group" style="display:none;">
            <label>Do you have a single billing point of contact?</label>
            <div class="radio-buttons">
                <input type="radio" id="single_billing_yes" name="single_billing" value="yes" required>
                <label for="single_billing_yes">Yes</label>
                <input type="radio" id="single_billing_no" name="single_billing" value="no">
                <label for="single_billing_no">No</label>
            </div>
        </div>
        <div id="single_billing_message" style="display:none; color:green;">
            Please add additional locations below to provide billing and shipping information for each location
        </div>
        <div id="locations">
            <div class="location">
                <h2>Primary Information</h2>
                <div>
                    <label>Purchasing Contact:</label>
                    <div class="row">
                        <input type="text" name="purchasing_first[0]" placeholder="First Name" required aria-label="Purchasing Contact First Name">
                        <input type="text" name="purchasing_last[0]" placeholder="Last Name" required aria-label="Purchasing Contact Last Name">
                    </div>
                    <div class="row">
                        <input type="email" name="purchasing_email[0]" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" required aria-label="Purchasing Contact Email">
                        <input type="tel" name="purchasing_phone[0]" placeholder="Phone Number" pattern="[0-9]{10,}" required aria-label="Purchasing Contact Phone">
                    </div>
                </div>
                <div>
                    <label>Billing Address:</label>
                    <div class="row">
                        <input type="text" name="billing_street[0]" placeholder="Street" required aria-label="Billing Street">
                        <input type="text" name="billing_city[0]" placeholder="City" required aria-label="Billing City">
                        <input type="text" name="billing_state[0]" placeholder="State" required aria-label="Billing State">
                        <input type="text" name="billing_zip[0]" placeholder="Zip Code" pattern="[0-9]{5}(-[0-9]{4})?" required aria-label="Billing Zip Code">
                    </div>
                </div>
                <div class="accounts-payable">
                    <label>Accounts Payable Contact:</label>
                    <div class="row">
                        <input type="text" name="ap_first[0]" placeholder="First Name" required aria-label="Accounts Payable First Name">
                        <input type="text" name="ap_last[0]" placeholder="Last Name" required aria-label="Accounts Payable Last Name">
                    </div>
                    <div class="row">
                        <input type="email" name="ap_email[0]" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" required aria-label="Accounts Payable Email">
                        <input type="tel" name="ap_phone[0]" placeholder="Phone Number" pattern="[0-9]{10,}" required aria-label="Accounts Payable Phone">
                    </div>
                </div>
                <div>
                    <label>Ship to Address:</label>
                    <div class="row">
                        <input type="text" name="ship_street[0]" placeholder="Street" required aria-label="Shipping Street">
                        <input type="text" name="ship_city[0]" placeholder="City" required aria-label="Shipping City">
                        <input type="text" name="ship_state[0]" placeholder="State" required aria-label="Shipping State">
                        <input type="text" name="ship_zip[0]" placeholder="Zip Code" pattern="[0-9]{5}(-[0-9]{4})?" required aria-label="Shipping Zip Code">
                    </div>
                </div>
                <div>
                    <label>Warehouse and/or Receiving Contact:</label>
                    <div class="row">
                        <input type="text" name="warehouse_first[0]" placeholder="First Name" required aria-label="Warehouse Contact First Name">
                        <input type="text" name="warehouse_last[0]" placeholder="Last Name" required aria-label="Warehouse Contact Last Name">
                    </div>
                    <div class="row">
                        <input type="email" name="warehouse_email[0]" placeholder="Email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" required aria-label="Warehouse Contact Email">
                        <input type="tel" name="warehouse_phone[0]" placeholder="Phone Number" pattern="[0-9]{10,}" required aria-label="Warehouse Contact Phone">
                    </div>
                </div>
                <div class="dropdown-group">
                    <label for="delivery_hours[0]">Dock Availability:</label>
                    <div class="dropdown-field">
                        <input type="text" id="delivery_hours[0]" name="delivery_hours[0]" placeholder="Hours & Days" required aria-label="Dock Availability">
                    </div>
                </div>
                <div class="radio-group">
                    <label>Liftgate Required?</label>
                    <div class="radio-buttons">
                        <input type="radio" id="liftgate_yes[0]" name="liftgate[0]" value="yes" required>
                        <label for="liftgate_yes[0]">Yes</label>
                        <input type="radio" id="liftgate_no[0]" name="liftgate[0]" value="no">
                        <label for="liftgate_no[0]">No</label>
                    </div>
                </div>
                <div class="radio-group">
                    <label>Delivery Appointment Required?</label>
                    <div class="radio-buttons">
                        <input type="radio" id="appt_yes[0]" name="appt[0]" value="yes" required>
                        <label for="appt_yes[0]">Yes</label>
                        <input type="radio" id="appt_no[0]" name="appt[0]" value="no">
                        <label for="appt_no[0]">No</label>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" onclick="addLocation()">Add More Locations</button>
        <div>
            <label for="notes">Special Account Notes:</label><br>
            <textarea id="notes" name="notes" maxlength="200" aria-label="Special Account Notes"></textarea>
        </div>
        <div id="signature-section">
            <div class="signature-container">
                <label for="signature-pad">Signature (Required):</label>
                <div id="signature-instructions" style="color: #ccc; font-size: 12px; margin-bottom: 5px;">
                    On desktop, use your mouse to draw your signature. On mobile, tap the button to open a full-screen signature pad.
                </div>
                <button type="button" id="open-signature-modal">Open Signature Pad</button>
                <canvas id="signature-pad" width="400" height="150" aria-label="Draw your signature here"></canvas>
                <input type="hidden" id="signature-data" name="signature" value="">
                <button type="button" id="clear-signature">Clear Signature</button>
            </div>
        </div>
        <div id="signature-modal">
            <div id="modal-instructions" aria-live="polite">
                Please rotate your device to landscape mode and use your finger or stylus to draw your signature.
            </div>
            <div id="modal-orientation-prompt" aria-live="assertive">
                Please rotate your device to landscape mode to sign.
            </div>
            <canvas id="modal-canvas"></canvas>
            <div id="modal-buttons">
                <button type="button" id="save-signature">Save Signature</button>
                <button type="button" id="close-signature-modal">Close</button>
            </div>
        </div>
        <button type="button" id="save-form">Save</button>
        <button type="button" id="clear-form">Clear</button>
        <button type="submit">Submit Form</button>
    </form>
</body>
</html>
